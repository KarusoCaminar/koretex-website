<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workflow Logs Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a1628;
      color: #e2e8f0;
      padding: 2rem;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      color: #3b82f6;
      margin-bottom: 1rem;
    }
    
    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    button {
      padding: 0.5rem 1rem;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #2563eb;
    }
    
    button.danger {
      background: #ef4444;
    }
    
    button.danger:hover {
      background: #dc2626;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 1rem;
      border-radius: 8px;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #3b82f6;
    }
    
    .logs-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .log-entry {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .log-entry:hover {
      border-color: #3b82f6;
    }
    
    .log-entry.expanded {
      border-color: #3b82f6;
    }
    
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .log-id {
      font-family: monospace;
      font-size: 0.85rem;
      color: #3b82f6;
    }
    
    .log-status {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .log-status.success {
      background: #22c55e;
      color: white;
    }
    
    .log-status.error {
      background: #ef4444;
      color: white;
    }
    
    .log-status.started {
      background: #f59e0b;
      color: white;
    }
    
    .log-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }
    
    .log-details {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #334155;
    }
    
    .log-entry.expanded .log-details {
      display: block;
    }
    
    .events-list {
      margin-top: 1rem;
    }
    
    .event-item {
      background: #0f172a;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      border-left: 3px solid #3b82f6;
    }
    
    .event-type {
      font-weight: bold;
      color: #3b82f6;
      margin-bottom: 0.25rem;
    }
    
    .event-timestamp {
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 0.5rem;
    }
    
    .event-data {
      font-family: monospace;
      font-size: 0.8rem;
      background: #020617;
      padding: 0.5rem;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .errors-list {
      margin-top: 1rem;
    }
    
    .error-item {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    
    .error-type {
      font-weight: bold;
      color: #ef4444;
      margin-bottom: 0.25rem;
    }
    
    .error-message {
      color: #fca5a5;
      margin-bottom: 0.5rem;
    }
    
    .no-logs {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }
    
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Workflow Logs Viewer</h1>
    
    <div class="controls">
      <button onclick="refreshLogs()">üîÑ Aktualisieren</button>
      <button onclick="downloadLogs()">üíæ Logs Downloaden (JSON)</button>
      <button onclick="clearLogs()" class="danger">üóëÔ∏è Alle Logs l√∂schen</button>
      <button onclick="showLastRun()">üëÅÔ∏è Letzter Run anzeigen</button>
      <button onclick="exportForAI()" style="background: #8b5cf6;">ü§ñ F√ºr AI exportieren</button>
      <button onclick="showErrorsSummary()" style="background: #ef4444;">‚ùå Fehler-Zusammenfassung</button>
    </div>
    
    <div class="stats" id="stats"></div>
    
    <div class="logs-container" id="logsContainer">
      <div class="no-logs">Keine Logs gefunden. Triggere einen Workflow auf der Website.</div>
    </div>
  </div>
  
  <script>
    let allLogs = [];
    
    function loadLogs() {
      try {
        const storedLogs = localStorage.getItem('workflowLogs');
        allLogs = storedLogs ? JSON.parse(storedLogs) : [];
        return allLogs;
      } catch (e) {
        console.error('Fehler beim Laden der Logs:', e);
        return [];
      }
    }
    
    function refreshLogs() {
      loadLogs();
      updateStats();
      renderLogs();
    }
    
    function updateStats() {
      const statsContainer = document.getElementById('stats');
      
      const total = allLogs.length;
      const success = allLogs.filter(l => l.status === 'success').length;
      const errors = allLogs.filter(l => l.status === 'error').length;
      const started = allLogs.filter(l => l.status === 'started').length;
      const withErrors = allLogs.filter(l => l.errors && l.errors.length > 0).length;
      
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Gesamt</div>
          <div class="stat-value">${total}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Erfolgreich</div>
          <div class="stat-value">${success}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fehler</div>
          <div class="stat-value">${errors}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Laufend</div>
          <div class="stat-value">${started}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Mit Fehlern</div>
          <div class="stat-value">${withErrors}</div>
        </div>
      `;
    }
    
    function renderLogs() {
      const container = document.getElementById('logsContainer');
      
      if (allLogs.length === 0) {
        container.innerHTML = '<div class="no-logs">Keine Logs gefunden. Triggere einen Workflow auf der Website.</div>';
        return;
      }
      
      container.innerHTML = allLogs.map(log => {
        const hasErrors = log.errors && log.errors.length > 0;
        const eventsHtml = log.events ? log.events.map(event => `
          <div class="event-item">
            <div class="event-type">${event.type}</div>
            <div class="event-timestamp">${event.timestamp}</div>
            <div class="event-data"><pre>${JSON.stringify(event.data, null, 2)}</pre></div>
          </div>
        `).join('') : '';
        
        const errorsHtml = hasErrors ? `
          <div class="errors-list">
            <h3 style="color: #ef4444; margin-bottom: 0.5rem;">‚ùå Fehler (${log.errors.length}):</h3>
            ${log.errors.map(error => `
              <div class="error-item">
                <div class="error-type">${error.type || 'error'}</div>
                <div class="error-message">${error.message || 'Unbekannter Fehler'}</div>
                ${error.stack ? `<div class="event-data"><pre>${error.stack}</pre></div>` : ''}
                ${error.body ? `<div class="event-data"><pre>${error.body}</pre></div>` : ''}
              </div>
            `).join('')}
          </div>
        ` : '';
        
        return `
          <div class="log-entry" onclick="toggleLog('${log.id}')" id="log-${log.id}">
            <div class="log-header">
              <div class="log-id">${log.id}</div>
              <div class="log-status ${log.status}">${log.status}</div>
            </div>
            <div class="log-meta">
              <div><strong>Zeit:</strong> ${new Date(log.timestamp).toLocaleString('de-DE')}</div>
              <div><strong>Sample:</strong> ${log.sampleParam || 'Upload'}</div>
              <div><strong>Method:</strong> ${log.method}</div>
              ${log.duration ? `<div><strong>Dauer:</strong> ${log.duration}</div>` : ''}
              ${hasErrors ? `<div><strong>Fehler:</strong> ${log.errors.length}</div>` : ''}
            </div>
            <div class="log-details">
              <div><strong>URL:</strong> ${log.workflowUrl}</div>
              <div><strong>Title:</strong> ${log.workflowTitle}</div>
              ${log.response ? `
                <div style="margin-top: 1rem;">
                  <strong>Response:</strong>
                  <div class="event-data"><pre>${JSON.stringify(log.response, null, 2)}</pre></div>
                </div>
              ` : ''}
              ${eventsHtml ? `
                <div class="events-list">
                  <h3 style="color: #3b82f6; margin-bottom: 0.5rem;">üìã Events (${log.events.length}):</h3>
                  ${eventsHtml}
                </div>
              ` : ''}
              ${errorsHtml}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleLog(logId) {
      const logElement = document.getElementById(`log-${logId}`);
      logElement.classList.toggle('expanded');
    }
    
    function downloadLogs() {
      const dataStr = JSON.stringify(allLogs, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `workflow-logs-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function clearLogs() {
      if (confirm('M√∂chtest du wirklich ALLE Logs l√∂schen?')) {
        localStorage.removeItem('workflowLogs');
        allLogs = [];
        refreshLogs();
      }
    }
    
    function showLastRun() {
      if (allLogs.length === 0) {
        alert('Keine Logs vorhanden.');
        return;
      }
      
      const lastLog = allLogs[0];
      const logElement = document.getElementById(`log-${lastLog.id}`);
      if (logElement) {
        logElement.classList.add('expanded');
        logElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Wenn Fehler vorhanden, markiere sie
        if (lastLog.errors && lastLog.errors.length > 0) {
          alert(`Letzter Run hat ${lastLog.errors.length} Fehler:\n\n${lastLog.errors.map(e => e.message || e.type).join('\n')}`);
        }
      }
    }
    
    // Initial load
    refreshLogs();
    
    // Auto-refresh alle 5 Sekunden
    setInterval(refreshLogs, 5000);
    
    // Lade Export-Funktionen
    (function() {
      const script = document.createElement('script');
      script.src = 'export-logs.js';
      script.onerror = function() {
        console.warn('‚ö†Ô∏è export-logs.js nicht gefunden');
      };
      document.head.appendChild(script);
    })();
    
    function exportForAI() {
      const exportData = exportLogsToFile();
      if (!exportData) {
        alert('‚ö†Ô∏è Keine Logs zum Exportieren gefunden');
        return;
      }
      
      // Erstelle AI-freundliche Zusammenfassung
      const aiReport = {
        exportTimestamp: exportData.exportTimestamp,
        summary: exportData.summary,
        lastRun: {
          id: exportData.lastRun?.id || null,
          timestamp: exportData.lastRun?.timestamp || null,
          status: exportData.lastRun?.status || null,
          sampleParam: exportData.lastRun?.sampleParam || null,
          workflowUrl: exportData.lastRun?.workflowUrl || null,
          duration: exportData.lastRun?.duration || null,
          errors: exportData.lastRunErrors.map(err => ({
            type: err.type || 'unknown',
            message: err.message || 'Keine Nachricht',
            status: err.status || null,
            body: err.body || null
          }))
        },
        recentErrors: exportData.allErrors.slice(0, 10).map(item => ({
          timestamp: item.timestamp,
          sampleParam: item.sampleParam,
          errorType: item.error.type || 'unknown',
          errorMessage: item.error.message || 'Keine Nachricht',
          errorStatus: item.error.status || null
        })),
        allLogs: exportData.logs.map(log => ({
          id: log.id,
          timestamp: log.timestamp,
          status: log.status,
          sampleParam: log.sampleParam,
          hasErrors: (log.errors && log.errors.length > 0),
          errorCount: log.errors ? log.errors.length : 0,
          duration: log.duration || null
        }))
      };
      
      const jsonStr = JSON.stringify(aiReport, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `workflow-errors-for-ai-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('‚úÖ AI-freundlicher Fehler-Report exportiert');
      console.log('üìã Zusammenfassung:', aiReport.summary);
      if (exportData.lastRunErrors.length > 0) {
        console.log('‚ùå Fehler im letzten Run:', exportData.lastRunErrors);
      }
    }
    
    function showErrorsSummary() {
      if (typeof showErrorSummary === 'function') {
        showErrorSummary();
      } else {
        // Fallback falls export-logs.js nicht geladen
        const logs = loadLogs();
        const errors = [];
        logs.forEach(log => {
          if (log.errors && log.errors.length > 0) {
            errors.push(...log.errors.map(err => ({
              logId: log.id,
              timestamp: log.timestamp,
              sampleParam: log.sampleParam,
              error: err
            })));
          }
        });
        
        if (errors.length === 0) {
          alert('‚úÖ Keine Fehler gefunden');
        } else {
          let summary = `‚ùå Gefundene Fehler (${errors.length}):\n\n`;
          errors.forEach((item, index) => {
            summary += `${index + 1}. [${item.timestamp}] ${item.sampleParam}\n`;
            summary += `   Typ: ${item.error.type || 'unknown'}\n`;
            summary += `   Nachricht: ${item.error.message || 'Keine Nachricht'}\n`;
            if (item.error.status) summary += `   HTTP Status: ${item.error.status}\n`;
            summary += '\n';
          });
          console.log(summary);
          alert(summary);
        }
      }
    }
  </script>
</body>
</html>

